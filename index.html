<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bijak Algebra Aulia - Belajar & Simpan</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            user-select: none;
        }

        .hidden-section { display: none !important; }

        .active-tab {
            background-color: #4f46e5;
            color: white;
            border-radius: 0.5rem;
        }

        .key-btn {
            @apply bg-white border-2 border-gray-100 p-4 rounded-2xl text-2xl font-bold shadow-sm active:bg-indigo-50 active:scale-95 transition-all flex items-center justify-center;
        }

        #scratch-pad-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 100; display: none; flex-direction: column;
        }

        #drawing-canvas { touch-action: none; cursor: crosshair; background: #fff; flex-grow: 1; width: 100%; }

        /* Login Overlay */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #4f46e5; z-index: 200; display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }

        .level-btn {
            @apply px-6 py-3 border-2 rounded-2xl text-sm md:text-base border-gray-200 text-gray-500 shadow-sm flex-1 max-w-[200px] transition-all;
        }

        .level-active {
            @apply border-indigo-600 bg-indigo-50 text-indigo-600 font-bold;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="hidden-section">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
            <span class="text-5xl mb-4 block">üëã</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang!</h2>
            <p class="text-gray-500 text-sm mb-6">Sila masukkan nama anda untuk mula belajar dan simpan skor.</p>
            <input type="text" id="input-nama" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-4 text-center font-bold focus:border-indigo-500 outline-none" placeholder="Nama Anda...">
            <button onclick="saveUserName()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">Mula Belajar</button>
        </div>
    </div>

    <!-- Navigasi Utama -->
    <nav id="main-nav" class="bg-white shadow-sm p-4 sticky top-0 z-20 border-b border-gray-100">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl font-bold text-indigo-600 flex items-center gap-2">
                <span class="text-3xl">üìê</span> Bijak Algebra Aulia
            </h1>
            <div class="bg-gray-100 p-1 rounded-xl flex">
                <button onclick="showTab('learn')" id="tab-learn" class="tab-btn px-4 py-2 text-sm font-semibold active-tab">Tutorial</button>
                <button onclick="showTab('solver')" id="tab-solver" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-600">Penyelesai</button>
                <button onclick="showTab('quiz')" id="tab-quiz" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-600">Latihan</button>
            </div>
        </div>
    </nav>

    <!-- Header Murid -->
    <div id="user-header" class="max-w-5xl mx-auto px-4 mt-2 flex justify-between items-center text-[10px] text-gray-400 font-bold uppercase tracking-widest">
        <div>HI, <span id="display-nama" class="text-indigo-600">MURID</span></div>
        <div id="sync-status" class="text-indigo-400 italic">Menyambung...</div>
    </div>

    <!-- PAPAN CAKAR (OVERLAY) -->
    <div id="scratch-pad-container">
        <div class="p-4 bg-white border-b flex justify-between items-center shadow-sm">
            <div id="scratch-question-ref" class="text-lg font-bold text-indigo-900 leading-none"></div>
            <div class="flex gap-2">
                <button onclick="setEraser(false)" id="pen-tool" class="bg-indigo-600 text-white p-2 rounded-xl border-2 border-indigo-600">‚úèÔ∏è</button>
                <button onclick="setEraser(true)" id="eraser-tool" class="bg-white text-gray-400 p-2 rounded-xl border-2 border-gray-100">üßΩ</button>
                <button onclick="clearCanvas()" class="bg-red-50 text-red-600 px-3 py-1 rounded-xl font-bold text-xs uppercase">Padam</button>
                <button onclick="toggleScratchPad()" class="bg-gray-800 text-white px-4 py-2 rounded-xl font-bold text-xs uppercase ml-2">Tutup</button>
            </div>
        </div>
        <canvas id="drawing-canvas"></canvas>
    </div>

    <main class="max-w-5xl mx-auto p-4 mt-2">
        <!-- PEMILIH TAHAP -->
        <div class="mb-8 flex justify-center gap-4">
            <button onclick="setLevel('beginner')" id="lvl-beginner" class="level-btn level-active">Tahap 1</button>
            <button onclick="setLevel('intermediate')" id="lvl-intermediate" class="level-btn">Tahap 2</button>
        </div>

        <!-- SEKSYEN: TUTORIAL -->
        <section id="section-learn" class="tab-content">
            <!-- Tutorial Tahap 1 -->
            <div id="learn-beginner" class="learn-level-content space-y-6">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 space-y-6">
                    <h2 class="text-xl font-bold text-indigo-800 flex items-center gap-2"><span>üìñ</span> Tutorial Tahap 1: Satu Langkah</h2>
                    <p class="text-sm text-gray-600">Gunakan teknik <b>Pindah & Tukar</b>. Matlamat kita adalah supaya <b class="text-indigo-600">x</b> duduk sendirian.</p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-6 rounded-2xl border-l-4 border-blue-400">
                            <h3 class="font-bold text-blue-800 mb-2">Contoh Tambah (+)</h3>
                            <p class="text-lg mb-4"><b class="text-indigo-600">x</b> <b class="text-red-500">+</b> <b class="text-orange-500">5</b> <b class="text-red-500">=</b> <b class="text-orange-500">12</b></p>
                            <p class="text-xs text-gray-600 mb-2">1. Pindahkan <b class="text-red-500">+5</b> melepasi simbol <b class="text-red-500">=</b>.</p>
                            <p class="text-xs text-gray-600 mb-2">2. Simbol <b class="text-red-500">+</b> berubah menjadi <b class="text-red-500">-</b>.</p>
                            <p class="bg-white p-2 rounded mt-2 font-bold"><b class="text-indigo-600">x</b> = 12 <b class="text-red-500">-</b> 5 = 7</p>
                        </div>
                        <div class="bg-orange-50 p-6 rounded-2xl border-l-4 border-orange-400">
                            <h3 class="font-bold text-orange-800 mb-2">Contoh Tolak (-)</h3>
                            <p class="text-lg mb-4"><b class="text-indigo-600">x</b> <b class="text-red-500">-</b> <b class="text-orange-500">8</b> <b class="text-red-500">=</b> <b class="text-orange-500">4</b></p>
                            <p class="text-xs text-gray-600 mb-2">1. Pindahkan <b class="text-red-500">-8</b> melepasi simbol <b class="text-red-500">=</b>.</p>
                            <p class="text-xs text-gray-600 mb-2">2. Simbol <b class="text-red-500">-</b> berubah menjadi <b class="text-red-500">+</b>.</p>
                            <p class="bg-white p-2 rounded mt-2 font-bold"><b class="text-indigo-600">x</b> = 4 <b class="text-red-500">+</b> 8 = 12</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tutorial Tahap 2 -->
            <div id="learn-intermediate" class="learn-level-content hidden-section space-y-6">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 space-y-6">
                    <h2 class="text-xl font-bold text-indigo-800 flex items-center gap-2"><span>üìò</span> Tutorial Tahap 2: Dua Langkah</h2>
                    <p class="text-sm text-gray-600">Kita selesaikan <b>Tambah/Tolak</b> dahulu, baru selesaikan <b>Darab</b>.</p>
                    
                    <div class="bg-indigo-50 p-6 rounded-2xl border-l-4 border-indigo-400">
                        <h3 class="font-bold text-indigo-800 mb-4">Contoh: <b class="text-orange-500">2</b><b class="text-indigo-600">x</b> <b class="text-red-500">+</b> <b class="text-orange-500">4</b> <b class="text-red-500">=</b> <b class="text-orange-500">10</b></h3>
                        <div class="space-y-4">
                            <div class="flex gap-3">
                                <span class="bg-white w-6 h-6 flex items-center justify-center rounded-full text-[10px] font-bold">1</span>
                                <p class="text-xs">Pindahkan <b class="text-red-500">+4</b> ke kanan: <br> <b class="text-orange-500">2</b><b class="text-indigo-600">x</b> = 10 - 4 = 6</p>
                            </div>
                            <div class="flex gap-3">
                                <span class="bg-white w-6 h-6 flex items-center justify-center rounded-full text-[10px] font-bold">2</span>
                                <p class="text-xs">Bahagi hasil dengan pekali (<b class="text-orange-500">2</b>): <br> <b class="text-indigo-600">x</b> = 6 √∑ 2</p>
                            </div>
                            <p class="font-bold text-green-600 text-lg">Jawapan: x = 3</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SEKSYEN: PENYELESAI -->
        <section id="section-solver" class="tab-content hidden-section">
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 text-center">
                <h2 class="text-xl font-bold text-indigo-900 mb-6">Penyelesai Automatik</h2>
                <div id="solver-ui-beginner" class="flex flex-wrap gap-4 items-center justify-center bg-gray-50 p-6 rounded-2xl mb-6">
                    <span class="text-3xl font-bold text-indigo-600">x</span>
                    <select id="s1-op" class="p-3 border-2 border-gray-200 rounded-xl font-bold text-xl text-red-500 bg-white">
                        <option value="+">+</option>
                        <option value="-">-</option>
                    </select>
                    <input type="number" id="s1-a" class="w-24 p-3 border-2 border-gray-200 rounded-xl text-center text-xl font-bold text-orange-500" placeholder="?">
                    <span class="text-3xl font-bold text-red-500">=</span>
                    <input type="number" id="s1-b" class="w-24 p-3 border-2 border-gray-200 rounded-xl text-center text-xl font-bold text-orange-500" placeholder="?">
                </div>
                <button onclick="calculateSolution()" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-bold text-lg">Kira Langkah Demi Langkah</button>
                <div id="solver-result" class="mt-6 text-left space-y-3"></div>
            </div>
        </section>

        <!-- SEKSYEN: KUIZ -->
        <section id="section-quiz" class="tab-content hidden-section">
            <div class="bg-white rounded-3xl p-6 md:p-12 shadow-sm border border-gray-100 text-center">
                <button onclick="toggleScratchPad()" class="mb-6 bg-indigo-50 border border-indigo-100 text-indigo-600 px-6 py-3 rounded-2xl text-sm font-bold flex items-center gap-2 mx-auto">
                    <span>‚úçÔ∏è</span> Tulis Jalan Kerja
                </button>
                <div id="quiz-question-container" class="text-4xl md:text-6xl font-black mb-6"></div>
                <div id="quiz-display" class="max-w-xs mx-auto text-4xl p-5 border-4 border-indigo-100 bg-white rounded-3xl min-h-[80px] flex items-center justify-center font-black text-indigo-900 mb-6 shadow-inner">
                    x = ?
                </div>
                
                <!-- Keypad -->
                <div class="max-w-xs mx-auto grid grid-cols-3 gap-3 mb-8">
                    <button onclick="pressKey('1')" class="key-btn">1</button>
                    <button onclick="pressKey('2')" class="key-btn">2</button>
                    <button onclick="pressKey('3')" class="key-btn">3</button>
                    <button onclick="pressKey('4')" class="key-btn">4</button>
                    <button onclick="pressKey('5')" class="key-btn">5</button>
                    <button onclick="pressKey('6')" class="key-btn">6</button>
                    <button onclick="pressKey('7')" class="key-btn">7</button>
                    <button onclick="pressKey('8')" class="key-btn">8</button>
                    <button onclick="pressKey('9')" class="key-btn">9</button>
                    <button onclick="pressKey('-')" class="key-btn bg-indigo-50 text-indigo-600">-</button>
                    <button onclick="pressKey('0')" class="key-btn">0</button>
                    <button onclick="pressKey('DEL')" class="key-btn bg-indigo-50 text-indigo-600">‚å´</button>
                </div>

                <button onclick="checkQuizAnswer()" class="w-full max-w-xs bg-green-600 text-white py-5 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition">Hantar Jawapan</button>
                <p id="quiz-feedback" class="h-12 mt-4 text-lg font-bold flex items-center justify-center"></p>

                <div class="mt-8 pt-8 border-t border-gray-50 grid grid-cols-2 gap-4">
                    <div class="text-left">
                        <span class="text-gray-400 text-[10px] block font-bold uppercase tracking-widest">Skor Markah</span>
                        <span id="quiz-score" class="text-3xl font-black text-indigo-600">0</span>
                    </div>
                    <div class="text-right">
                        <button onclick="generateQuestion()" class="text-indigo-600 font-bold hover:underline text-sm mt-4">Tukar Soalan</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'algebra-aulia-v1';

        let user = null;

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                checkLocalName();
            } else {
                initAuth();
            }
        });

        function checkLocalName() {
            const savedName = localStorage.getItem('algebra_user_name');
            if (savedName) {
                document.getElementById('display-nama').innerText = savedName.toUpperCase();
                loadDataFromCloud();
            } else {
                document.getElementById('login-overlay').classList.remove('hidden-section');
            }
        }

        window.saveUserName = async () => {
            const name = document.getElementById('input-nama').value.trim();
            if (!name) return;
            
            localStorage.setItem('algebra_user_name', name);
            document.getElementById('display-nama').innerText = name.toUpperCase();
            document.getElementById('login-overlay').classList.add('hidden-section');
            
            if (user) {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', 'data');
                await setDoc(docRef, { name: name, score: 0, lastSeen: new Date() }, { merge: true });
                document.getElementById('sync-status').innerText = "‚úÖ Tersimpan";
            }
        };

        async function loadDataFromCloud() {
            if (!user) return;
            document.getElementById('sync-status').innerText = "Memuatkan...";
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', 'data');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.currentScore = data.score || 0;
                    document.getElementById('quiz-score').innerText = window.currentScore;
                }
                document.getElementById('sync-status').innerText = "‚úÖ Tersambung";
            } catch (e) {
                document.getElementById('sync-status').innerText = "‚ö†Ô∏è Luar Talian";
            }
        }

        window.syncScore = async (newScore) => {
            if (!user) return;
            document.getElementById('sync-status').innerText = "Menyimpan...";
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', 'data');
                await setDoc(docRef, { score: newScore, updatedAt: new Date() }, { merge: true });
                document.getElementById('sync-status').innerText = "‚úÖ Tersimpan";
            } catch (e) {
                document.getElementById('sync-status').innerText = "‚ö†Ô∏è Ralat";
            }
        };
    </script>

    <script>
        let currentLevel = 'beginner';
        window.currentScore = 0;
        let activeQuestion = {};
        let currentInput = "";
        let isEraser = false;

        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function initCanvas() {
            setTimeout(() => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight - 100;
                ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.strokeStyle = isEraser ? '#ffffff' : '#312e81';
            }, 50);
        }

        function setEraser(s) {
            isEraser = s;
            ctx.strokeStyle = isEraser ? '#ffffff' : '#312e81';
            ctx.lineWidth = isEraser ? 30 : 4;
            document.getElementById('pen-tool').classList.toggle('bg-indigo-600', !isEraser);
            document.getElementById('eraser-tool').classList.toggle('bg-indigo-600', isEraser);
        }

        function draw(e) {
            if (!drawing) return;
            const rect = canvas.getBoundingClientRect();
            const cx = (e.clientX || e.touches[0].clientX) - rect.left;
            const cy = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.lineTo(cx, cy); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx, cy);
        }

        canvas.addEventListener('mousedown', () => drawing = true);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; draw(e); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
        canvas.addEventListener('touchend', () => { drawing = false; ctx.beginPath(); });

        function toggleScratchPad() {
            const pad = document.getElementById('scratch-pad-container');
            if (pad.style.display !== 'flex') {
                const qText = document.getElementById('quiz-question-container').innerHTML;
                document.getElementById('scratch-question-ref').innerHTML = qText || "Papan Kerja";
                pad.style.display = 'flex'; initCanvas();
            } else pad.style.display = 'none';
        }

        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-section'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab', 'text-gray-600'));
            document.getElementById('section-' + t).classList.remove('hidden-section');
            document.getElementById('tab-' + t).classList.add('active-tab');
            if (t === 'quiz') generateQuestion();
        }

        function setLevel(lvl) {
            currentLevel = lvl;
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('level-active'));
            document.getElementById('lvl-' + lvl).classList.add('level-active');
            
            // Tunjukkan tutorial yang betul
            document.querySelectorAll('.learn-level-content').forEach(el => el.classList.add('hidden-section'));
            document.getElementById('learn-' + lvl).classList.remove('hidden-section');
            
            generateQuestion();
        }

        function pressKey(k) {
            if (k === 'DEL') currentInput = currentInput.slice(0, -1);
            else if (k === '-') currentInput = currentInput === "" ? "-" : (currentInput === "-" ? "" : currentInput);
            else if (currentInput.length < 5) currentInput += k;
            document.getElementById('quiz-display').innerText = currentInput === "" ? "x = ?" : "x = " + currentInput;
        }

        function generateQuestion() {
            currentInput = ""; document.getElementById('quiz-display').innerText = "x = ?";
            const a = Math.floor(Math.random() * 10) + 1;
            const b = Math.floor(Math.random() * 20) + 1;
            const op = Math.random() > 0.5 ? '+' : '-';
            if (currentLevel === 'beginner') {
                activeQuestion = { ans: op === '+' ? b - a : b + a };
                document.getElementById('quiz-question-container').innerHTML = `<span class="text-indigo-600">x</span> <span class="text-red-500">${op}</span> <span class="text-orange-500">${a}</span> = <span class="text-orange-500">${b}</span>`;
            } else {
                const c = Math.floor(Math.random() * 3) + 2;
                const ans = Math.floor(Math.random() * 5) + 1;
                const finalB = op === '+' ? (c * ans) + a : (c * ans) - a;
                activeQuestion = { ans: ans };
                document.getElementById('quiz-question-container').innerHTML = `<span class="text-orange-500">${c}</span><span class="text-indigo-600">x</span> <span class="text-red-500">${op}</span> <span class="text-orange-500">${a}</span> = <span class="text-orange-500">${finalB}</span>`;
            }
        }

        function checkQuizAnswer() {
            if (currentInput === "" || currentInput === "-") return;
            const userVal = parseFloat(currentInput);
            const fb = document.getElementById('quiz-feedback');
            if (userVal === activeQuestion.ans) {
                fb.innerText = "üåü BETUL!"; fb.className = "text-green-600 font-bold h-12 flex items-center justify-center";
                window.currentScore += 10;
                document.getElementById('quiz-score').innerText = window.currentScore;
                if (window.syncScore) window.syncScore(window.currentScore);
                setTimeout(generateQuestion, 1500);
            } else {
                fb.innerText = "‚ùå SALAH! Sila cuba lagi."; fb.className = "text-red-500 font-bold h-12 flex items-center justify-center";
            }
        }

        function calculateSolution() {
            const container = document.getElementById('solver-result');
            container.innerHTML = "";
            const op = document.getElementById('s1-op').value;
            const a = parseFloat(document.getElementById('s1-a').value);
            const b = parseFloat(document.getElementById('s1-b').value);
            if (isNaN(a) || isNaN(b)) return;
            const ans = op === '+' ? b - a : b + a;
            const opp = op === '+' ? '-' : '+';
            container.innerHTML = `
                <div class="p-5 bg-indigo-50 rounded-2xl border border-indigo-100 shadow-sm text-sm space-y-2">
                    <p>1. Pindahkan <b class="text-red-500">${op}${a}</b> melepasi simbol <b class="text-red-500">=</b> jadi <b class="text-red-500">${opp}${a}</b>.</p>
                    <p>2. <b class="text-indigo-600">x</b> = ${b} ${opp} ${a}</p>
                    <p class="font-bold text-green-600 text-lg">3. Jawapan: x = ${ans}</p>
                </div>
            `;
        }

        window.onload = () => generateQuestion();
    </script>
</body>
</html>
